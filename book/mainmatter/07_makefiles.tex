\chapter{Makefiles}

\includegraphics[scale=0.20]{../images/books-1163695_1920.jpg}

\justify
A Makefile is a good way to put shorts sets of oft repeated steps at the
fingertips of the developer. Rather than typing three complicated and
possibly hard to recall strings to kick off your Docker container, you
can simply type make docker and have everything build as desired. We're
going to be using GNU Make for our projects.

\section{The PHONY Directive}

\justify
If a file or directory exists with the same name as a stanza in the
Makefile, you will need to specify it under the \emph{PHONY} directive.
This will allow the Makefile to find and run the desired commands.

\justify
Consider this example, where we have three directories (docker, docs,
and python) and we also have three Makefile directives of the same name:

\begin{mybox}{\thetcbcounter: The PHONY Directive}
	.PHONY: docker docs python
\end{mybox}

\section{Targets}

\justify
Makefiles are comprised of various stanzas, know as targets. This is where the work gets done. Let's add a target for Docker and a target for
Python to make our lives easier in the future. Consider the two target stanzas below.

\justify
\begin{mybox}{\thetcbcounter: A Makefile Target}
	\lstinputlisting{code/makefile-target}
\end{mybox}

\justify
When the user types make docker at the CLI to invoke the docker target
in the Makefile, the fist thing that happens is the python target is
called. If the file python/requirements.txt exists, we attempt to
install the modules listed within that requirements file using the
Python "pip" package manager. Once completed, the thread of execution
returns to the docker target. A message is sent to the user via STDOUT
that we will be building with docker-compose. An empty file at the root
of the containers filesystem named /.dockerenv is a convention that
indicates we are operating inside a containerized environment. After a
quick check for existence of the file /.dockerenv, we use docker-compose
to build from our Dockerfile, and then start a BASH shell in our
"cloudlab" container. The user now has the ability to run BASH commands
"inside" the Docker container.

\justify
Be sure when you indent in a Makefile that you use tabs, not spaces. You
can use the backslash character in a Makefile to combine two consecutive
lines into one logical line.

\section{Full Example Makefile}

Let's look at the example projet repo to see a full eaxample of a working Makefile.

\section{Directory Structure with Makefile}

\justify
Relevant files and folders related to our Makefile are organized as seen
below.

\begin{figure}[!htb]
	\input{dot/makefile.tex}
	\caption{Makefile and related files.}
\end{figure}
